{"ast":null,"code":"'use strict';\n\nmodule.exports = createOrbitController;\n\nvar filterVector = require('filtered-vector');\n\nvar lookAt = require('gl-mat4/lookAt');\n\nvar mat4FromQuat = require('gl-mat4/fromQuat');\n\nvar invert44 = require('gl-mat4/invert');\n\nvar quatFromFrame = require('./lib/quatFromFrame');\n\nfunction len3(x, y, z) {\n  return Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2) + Math.pow(z, 2));\n}\n\nfunction len4(w, x, y, z) {\n  return Math.sqrt(Math.pow(w, 2) + Math.pow(x, 2) + Math.pow(y, 2) + Math.pow(z, 2));\n}\n\nfunction normalize4(out, a) {\n  var ax = a[0];\n  var ay = a[1];\n  var az = a[2];\n  var aw = a[3];\n  var al = len4(ax, ay, az, aw);\n\n  if (al > 1e-6) {\n    out[0] = ax / al;\n    out[1] = ay / al;\n    out[2] = az / al;\n    out[3] = aw / al;\n  } else {\n    out[0] = out[1] = out[2] = 0.0;\n    out[3] = 1.0;\n  }\n}\n\nfunction OrbitCameraController(initQuat, initCenter, initRadius) {\n  this.radius = filterVector([initRadius]);\n  this.center = filterVector(initCenter);\n  this.rotation = filterVector(initQuat);\n  this.computedRadius = this.radius.curve(0);\n  this.computedCenter = this.center.curve(0);\n  this.computedRotation = this.rotation.curve(0);\n  this.computedUp = [0.1, 0, 0];\n  this.computedEye = [0.1, 0, 0];\n  this.computedMatrix = [0.1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n  this.recalcMatrix(0);\n}\n\nvar proto = OrbitCameraController.prototype;\n\nproto.lastT = function () {\n  return Math.max(this.radius.lastT(), this.center.lastT(), this.rotation.lastT());\n};\n\nproto.recalcMatrix = function (t) {\n  this.radius.curve(t);\n  this.center.curve(t);\n  this.rotation.curve(t);\n  var quat = this.computedRotation;\n  normalize4(quat, quat);\n  var mat = this.computedMatrix;\n  mat4FromQuat(mat, quat);\n  var center = this.computedCenter;\n  var eye = this.computedEye;\n  var up = this.computedUp;\n  var radius = Math.exp(this.computedRadius[0]);\n  eye[0] = center[0] + radius * mat[2];\n  eye[1] = center[1] + radius * mat[6];\n  eye[2] = center[2] + radius * mat[10];\n  up[0] = mat[1];\n  up[1] = mat[5];\n  up[2] = mat[9];\n\n  for (var i = 0; i < 3; ++i) {\n    var rr = 0.0;\n\n    for (var j = 0; j < 3; ++j) {\n      rr += mat[i + 4 * j] * eye[j];\n    }\n\n    mat[12 + i] = -rr;\n  }\n};\n\nproto.getMatrix = function (t, result) {\n  this.recalcMatrix(t);\n  var m = this.computedMatrix;\n\n  if (result) {\n    for (var i = 0; i < 16; ++i) {\n      result[i] = m[i];\n    }\n\n    return result;\n  }\n\n  return m;\n};\n\nproto.idle = function (t) {\n  this.center.idle(t);\n  this.radius.idle(t);\n  this.rotation.idle(t);\n};\n\nproto.flush = function (t) {\n  this.center.flush(t);\n  this.radius.flush(t);\n  this.rotation.flush(t);\n};\n\nproto.pan = function (t, dx, dy, dz) {\n  dx = dx || 0.0;\n  dy = dy || 0.0;\n  dz = dz || 0.0;\n  this.recalcMatrix(t);\n  var mat = this.computedMatrix;\n  var ux = mat[1];\n  var uy = mat[5];\n  var uz = mat[9];\n  var ul = len3(ux, uy, uz);\n  ux /= ul;\n  uy /= ul;\n  uz /= ul;\n  var rx = mat[0];\n  var ry = mat[4];\n  var rz = mat[8];\n  var ru = rx * ux + ry * uy + rz * uz;\n  rx -= ux * ru;\n  ry -= uy * ru;\n  rz -= uz * ru;\n  var rl = len3(rx, ry, rz);\n  rx /= rl;\n  ry /= rl;\n  rz /= rl;\n  var fx = mat[2];\n  var fy = mat[6];\n  var fz = mat[10];\n  var fu = fx * ux + fy * uy + fz * uz;\n  var fr = fx * rx + fy * ry + fz * rz;\n  fx -= fu * ux + fr * rx;\n  fy -= fu * uy + fr * ry;\n  fz -= fu * uz + fr * rz;\n  var fl = len3(fx, fy, fz);\n  fx /= fl;\n  fy /= fl;\n  fz /= fl;\n  var vx = rx * dx + ux * dy;\n  var vy = ry * dx + uy * dy;\n  var vz = rz * dx + uz * dy;\n  this.center.move(t, vx, vy, vz); //Update z-component of radius\n\n  var radius = Math.exp(this.computedRadius[0]);\n  radius = Math.max(1e-4, radius + dz);\n  this.radius.set(t, Math.log(radius));\n};\n\nproto.rotate = function (t, dx, dy, dz) {\n  this.recalcMatrix(t);\n  dx = dx || 0.0;\n  dy = dy || 0.0;\n  var mat = this.computedMatrix;\n  var rx = mat[0];\n  var ry = mat[4];\n  var rz = mat[8];\n  var ux = mat[1];\n  var uy = mat[5];\n  var uz = mat[9];\n  var fx = mat[2];\n  var fy = mat[6];\n  var fz = mat[10];\n  var qx = dx * rx + dy * ux;\n  var qy = dx * ry + dy * uy;\n  var qz = dx * rz + dy * uz;\n  var bx = -(fy * qz - fz * qy);\n  var by = -(fz * qx - fx * qz);\n  var bz = -(fx * qy - fy * qx);\n  var bw = Math.sqrt(Math.max(0.0, 1.0 - Math.pow(bx, 2) - Math.pow(by, 2) - Math.pow(bz, 2)));\n  var bl = len4(bx, by, bz, bw);\n\n  if (bl > 1e-6) {\n    bx /= bl;\n    by /= bl;\n    bz /= bl;\n    bw /= bl;\n  } else {\n    bx = by = bz = 0.0;\n    bw = 1.0;\n  }\n\n  var rotation = this.computedRotation;\n  var ax = rotation[0];\n  var ay = rotation[1];\n  var az = rotation[2];\n  var aw = rotation[3];\n  var cx = ax * bw + aw * bx + ay * bz - az * by;\n  var cy = ay * bw + aw * by + az * bx - ax * bz;\n  var cz = az * bw + aw * bz + ax * by - ay * bx;\n  var cw = aw * bw - ax * bx - ay * by - az * bz; //Apply roll\n\n  if (dz) {\n    bx = fx;\n    by = fy;\n    bz = fz;\n    var s = Math.sin(dz) / len3(bx, by, bz);\n    bx *= s;\n    by *= s;\n    bz *= s;\n    bw = Math.cos(dx);\n    cx = cx * bw + cw * bx + cy * bz - cz * by;\n    cy = cy * bw + cw * by + cz * bx - cx * bz;\n    cz = cz * bw + cw * bz + cx * by - cy * bx;\n    cw = cw * bw - cx * bx - cy * by - cz * bz;\n  }\n\n  var cl = len4(cx, cy, cz, cw);\n\n  if (cl > 1e-6) {\n    cx /= cl;\n    cy /= cl;\n    cz /= cl;\n    cw /= cl;\n  } else {\n    cx = cy = cz = 0.0;\n    cw = 1.0;\n  }\n\n  this.rotation.set(t, cx, cy, cz, cw);\n};\n\nproto.lookAt = function (t, eye, center, up) {\n  this.recalcMatrix(t);\n  center = center || this.computedCenter;\n  eye = eye || this.computedEye;\n  up = up || this.computedUp;\n  var mat = this.computedMatrix;\n  lookAt(mat, eye, center, up);\n  var rotation = this.computedRotation;\n  quatFromFrame(rotation, mat[0], mat[1], mat[2], mat[4], mat[5], mat[6], mat[8], mat[9], mat[10]);\n  normalize4(rotation, rotation);\n  this.rotation.set(t, rotation[0], rotation[1], rotation[2], rotation[3]);\n  var fl = 0.0;\n\n  for (var i = 0; i < 3; ++i) {\n    fl += Math.pow(center[i] - eye[i], 2);\n  }\n\n  this.radius.set(t, 0.5 * Math.log(Math.max(fl, 1e-6)));\n  this.center.set(t, center[0], center[1], center[2]);\n};\n\nproto.translate = function (t, dx, dy, dz) {\n  this.center.move(t, dx || 0.0, dy || 0.0, dz || 0.0);\n};\n\nproto.setMatrix = function (t, matrix) {\n  var rotation = this.computedRotation;\n  quatFromFrame(rotation, matrix[0], matrix[1], matrix[2], matrix[4], matrix[5], matrix[6], matrix[8], matrix[9], matrix[10]);\n  normalize4(rotation, rotation);\n  this.rotation.set(t, rotation[0], rotation[1], rotation[2], rotation[3]);\n  var mat = this.computedMatrix;\n  invert44(mat, matrix);\n  var w = mat[15];\n\n  if (Math.abs(w) > 1e-6) {\n    var cx = mat[12] / w;\n    var cy = mat[13] / w;\n    var cz = mat[14] / w;\n    this.recalcMatrix(t);\n    var r = Math.exp(this.computedRadius[0]);\n    this.center.set(t, cx - mat[2] * r, cy - mat[6] * r, cz - mat[10] * r);\n    this.radius.idle(t);\n  } else {\n    this.center.idle(t);\n    this.radius.idle(t);\n  }\n};\n\nproto.setDistance = function (t, d) {\n  if (d > 0) {\n    this.radius.set(t, Math.log(d));\n  }\n};\n\nproto.setDistanceLimits = function (lo, hi) {\n  if (lo > 0) {\n    lo = Math.log(lo);\n  } else {\n    lo = -Infinity;\n  }\n\n  if (hi > 0) {\n    hi = Math.log(hi);\n  } else {\n    hi = Infinity;\n  }\n\n  hi = Math.max(hi, lo);\n  this.radius.bounds[0][0] = lo;\n  this.radius.bounds[1][0] = hi;\n};\n\nproto.getDistanceLimits = function (out) {\n  var bounds = this.radius.bounds;\n\n  if (out) {\n    out[0] = Math.exp(bounds[0][0]);\n    out[1] = Math.exp(bounds[1][0]);\n    return out;\n  }\n\n  return [Math.exp(bounds[0][0]), Math.exp(bounds[1][0])];\n};\n\nproto.toJSON = function () {\n  this.recalcMatrix(this.lastT());\n  return {\n    center: this.computedCenter.slice(),\n    rotation: this.computedRotation.slice(),\n    distance: Math.log(this.computedRadius[0]),\n    zoomMin: this.radius.bounds[0][0],\n    zoomMax: this.radius.bounds[1][0]\n  };\n};\n\nproto.fromJSON = function (options) {\n  var t = this.lastT();\n  var c = options.center;\n\n  if (c) {\n    this.center.set(t, c[0], c[1], c[2]);\n  }\n\n  var r = options.rotation;\n\n  if (r) {\n    this.rotation.set(t, r[0], r[1], r[2], r[3]);\n  }\n\n  var d = options.distance;\n\n  if (d && d > 0) {\n    this.radius.set(t, Math.log(d));\n  }\n\n  this.setDistanceLimits(options.zoomMin, options.zoomMax);\n};\n\nfunction createOrbitController(options) {\n  options = options || {};\n  var center = options.center || [0, 0, 0];\n  var rotation = options.rotation || [0, 0, 0, 1];\n  var radius = options.radius || 1.0;\n  center = [].slice.call(center, 0, 3);\n  rotation = [].slice.call(rotation, 0, 4);\n  normalize4(rotation, rotation);\n  var result = new OrbitCameraController(rotation, center, Math.log(radius));\n  result.setDistanceLimits(options.zoomMin, options.zoomMax);\n\n  if ('eye' in options || 'up' in options) {\n    result.lookAt(0, options.eye, options.center, options.up);\n  }\n\n  return result;\n}","map":{"version":3,"sources":["/Users/jingkaisu/Documents/HRfront/HalliganReviews/web_project/node_modules/orbit-camera-controller/orbit.js"],"names":["module","exports","createOrbitController","filterVector","require","lookAt","mat4FromQuat","invert44","quatFromFrame","len3","x","y","z","Math","sqrt","pow","len4","w","normalize4","out","a","ax","ay","az","aw","al","OrbitCameraController","initQuat","initCenter","initRadius","radius","center","rotation","computedRadius","curve","computedCenter","computedRotation","computedUp","computedEye","computedMatrix","recalcMatrix","proto","prototype","lastT","max","t","quat","mat","eye","up","exp","i","rr","j","getMatrix","result","m","idle","flush","pan","dx","dy","dz","ux","uy","uz","ul","rx","ry","rz","ru","rl","fx","fy","fz","fu","fr","fl","vx","vy","vz","move","set","log","rotate","qx","qy","qz","bx","by","bz","bw","bl","cx","cy","cz","cw","s","sin","cos","cl","translate","setMatrix","matrix","abs","r","setDistance","d","setDistanceLimits","lo","hi","Infinity","bounds","getDistanceLimits","toJSON","slice","distance","zoomMin","zoomMax","fromJSON","options","c","call"],"mappings":"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","sourcesContent":["'use strict'\n\nmodule.exports = createOrbitController\n\nvar filterVector  = require('filtered-vector')\nvar lookAt        = require('gl-mat4/lookAt')\nvar mat4FromQuat  = require('gl-mat4/fromQuat')\nvar invert44      = require('gl-mat4/invert')\nvar quatFromFrame = require('./lib/quatFromFrame')\n\nfunction len3(x,y,z) {\n  return Math.sqrt(Math.pow(x,2) + Math.pow(y,2) + Math.pow(z,2))\n}\n\nfunction len4(w,x,y,z) {\n  return Math.sqrt(Math.pow(w,2) + Math.pow(x,2) + Math.pow(y,2) + Math.pow(z,2))\n}\n\nfunction normalize4(out, a) {\n  var ax = a[0]\n  var ay = a[1]\n  var az = a[2]\n  var aw = a[3]\n  var al = len4(ax, ay, az, aw)\n  if(al > 1e-6) {\n    out[0] = ax/al\n    out[1] = ay/al\n    out[2] = az/al\n    out[3] = aw/al\n  } else {\n    out[0] = out[1] = out[2] = 0.0\n    out[3] = 1.0\n  }\n}\n\nfunction OrbitCameraController(initQuat, initCenter, initRadius) {\n  this.radius    = filterVector([initRadius])\n  this.center    = filterVector(initCenter)\n  this.rotation  = filterVector(initQuat)\n\n  this.computedRadius   = this.radius.curve(0)\n  this.computedCenter   = this.center.curve(0)\n  this.computedRotation = this.rotation.curve(0)\n  this.computedUp       = [0.1,0,0]\n  this.computedEye      = [0.1,0,0]\n  this.computedMatrix   = [0.1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]\n\n  this.recalcMatrix(0)\n}\n\nvar proto = OrbitCameraController.prototype\n\nproto.lastT = function() {\n  return Math.max(\n    this.radius.lastT(),\n    this.center.lastT(),\n    this.rotation.lastT())\n}\n\nproto.recalcMatrix = function(t) {\n  this.radius.curve(t)\n  this.center.curve(t)\n  this.rotation.curve(t)\n\n  var quat = this.computedRotation\n  normalize4(quat, quat)\n\n  var mat = this.computedMatrix\n  mat4FromQuat(mat, quat)\n\n  var center = this.computedCenter\n  var eye    = this.computedEye\n  var up     = this.computedUp\n  var radius = Math.exp(this.computedRadius[0])\n\n  eye[0] = center[0] + radius * mat[2]\n  eye[1] = center[1] + radius * mat[6]\n  eye[2] = center[2] + radius * mat[10]\n  up[0] = mat[1]\n  up[1] = mat[5]\n  up[2] = mat[9]\n\n  for(var i=0; i<3; ++i) {\n    var rr = 0.0\n    for(var j=0; j<3; ++j) {\n      rr += mat[i+4*j] * eye[j]\n    }\n    mat[12+i] = -rr\n  }\n}\n\nproto.getMatrix = function(t, result) {\n  this.recalcMatrix(t)\n  var m = this.computedMatrix\n  if(result) {\n    for(var i=0; i<16; ++i) {\n      result[i] = m[i]\n    }\n    return result\n  }\n  return m\n}\n\nproto.idle = function(t) {\n  this.center.idle(t)\n  this.radius.idle(t)\n  this.rotation.idle(t)\n}\n\nproto.flush = function(t) {\n  this.center.flush(t)\n  this.radius.flush(t)\n  this.rotation.flush(t)\n}\n\nproto.pan = function(t, dx, dy, dz) {\n  dx = dx || 0.0\n  dy = dy || 0.0\n  dz = dz || 0.0\n\n  this.recalcMatrix(t)\n  var mat = this.computedMatrix\n\n  var ux = mat[1]\n  var uy = mat[5]\n  var uz = mat[9]\n  var ul = len3(ux, uy, uz)\n  ux /= ul\n  uy /= ul\n  uz /= ul\n\n  var rx = mat[0]\n  var ry = mat[4]\n  var rz = mat[8]\n  var ru = rx * ux + ry * uy + rz * uz\n  rx -= ux * ru\n  ry -= uy * ru\n  rz -= uz * ru\n  var rl = len3(rx, ry, rz)\n  rx /= rl\n  ry /= rl\n  rz /= rl\n\n  var fx = mat[2]\n  var fy = mat[6]\n  var fz = mat[10]\n  var fu = fx * ux + fy * uy + fz * uz\n  var fr = fx * rx + fy * ry + fz * rz\n  fx -= fu * ux + fr * rx\n  fy -= fu * uy + fr * ry\n  fz -= fu * uz + fr * rz\n  var fl = len3(fx, fy, fz)\n  fx /= fl\n  fy /= fl\n  fz /= fl\n\n  var vx = rx * dx + ux * dy\n  var vy = ry * dx + uy * dy\n  var vz = rz * dx + uz * dy\n\n  this.center.move(t, vx, vy, vz)\n\n  //Update z-component of radius\n  var radius = Math.exp(this.computedRadius[0])\n  radius = Math.max(1e-4, radius + dz)\n  this.radius.set(t, Math.log(radius))\n}\n\nproto.rotate = function(t, dx, dy, dz) {\n  this.recalcMatrix(t)\n\n  dx = dx||0.0\n  dy = dy||0.0\n\n  var mat = this.computedMatrix\n\n  var rx = mat[0]\n  var ry = mat[4]\n  var rz = mat[8]\n\n  var ux = mat[1]\n  var uy = mat[5]\n  var uz = mat[9]\n\n  var fx = mat[2]\n  var fy = mat[6]\n  var fz = mat[10]\n\n  var qx = dx * rx + dy * ux\n  var qy = dx * ry + dy * uy\n  var qz = dx * rz + dy * uz\n\n  var bx = -(fy * qz - fz * qy)\n  var by = -(fz * qx - fx * qz)\n  var bz = -(fx * qy - fy * qx)  \n  var bw = Math.sqrt(Math.max(0.0, 1.0 - Math.pow(bx,2) - Math.pow(by,2) - Math.pow(bz,2)))\n  var bl = len4(bx, by, bz, bw)\n  if(bl > 1e-6) {\n    bx /= bl\n    by /= bl\n    bz /= bl\n    bw /= bl\n  } else {\n    bx = by = bz = 0.0\n    bw = 1.0\n  }\n\n  var rotation = this.computedRotation\n  var ax = rotation[0]\n  var ay = rotation[1]\n  var az = rotation[2]\n  var aw = rotation[3]\n\n  var cx = ax*bw + aw*bx + ay*bz - az*by\n  var cy = ay*bw + aw*by + az*bx - ax*bz\n  var cz = az*bw + aw*bz + ax*by - ay*bx\n  var cw = aw*bw - ax*bx - ay*by - az*bz\n  \n  //Apply roll\n  if(dz) {\n    bx = fx\n    by = fy\n    bz = fz\n    var s = Math.sin(dz) / len3(bx, by, bz)\n    bx *= s\n    by *= s\n    bz *= s\n    bw = Math.cos(dx)\n    cx = cx*bw + cw*bx + cy*bz - cz*by\n    cy = cy*bw + cw*by + cz*bx - cx*bz\n    cz = cz*bw + cw*bz + cx*by - cy*bx\n    cw = cw*bw - cx*bx - cy*by - cz*bz\n  }\n\n  var cl = len4(cx, cy, cz, cw)\n  if(cl > 1e-6) {\n    cx /= cl\n    cy /= cl\n    cz /= cl\n    cw /= cl\n  } else {\n    cx = cy = cz = 0.0\n    cw = 1.0\n  }\n\n  this.rotation.set(t, cx, cy, cz, cw)\n}\n\nproto.lookAt = function(t, eye, center, up) {\n  this.recalcMatrix(t)\n\n  center = center || this.computedCenter\n  eye    = eye    || this.computedEye\n  up     = up     || this.computedUp\n\n  var mat = this.computedMatrix\n  lookAt(mat, eye, center, up)\n\n  var rotation = this.computedRotation\n  quatFromFrame(rotation,\n    mat[0], mat[1], mat[2],\n    mat[4], mat[5], mat[6],\n    mat[8], mat[9], mat[10])\n  normalize4(rotation, rotation)\n  this.rotation.set(t, rotation[0], rotation[1], rotation[2], rotation[3])\n\n  var fl = 0.0\n  for(var i=0; i<3; ++i) {\n    fl += Math.pow(center[i] - eye[i], 2)\n  }\n  this.radius.set(t, 0.5 * Math.log(Math.max(fl, 1e-6)))\n\n  this.center.set(t, center[0], center[1], center[2])\n}\n\nproto.translate = function(t, dx, dy, dz) {\n  this.center.move(t,\n    dx||0.0,\n    dy||0.0,\n    dz||0.0)\n}\n\nproto.setMatrix = function(t, matrix) {\n\n  var rotation = this.computedRotation\n  quatFromFrame(rotation,\n    matrix[0], matrix[1], matrix[2],\n    matrix[4], matrix[5], matrix[6],\n    matrix[8], matrix[9], matrix[10])\n  normalize4(rotation, rotation)\n  this.rotation.set(t, rotation[0], rotation[1], rotation[2], rotation[3])\n\n  var mat = this.computedMatrix\n  invert44(mat, matrix)\n  var w = mat[15]\n  if(Math.abs(w) > 1e-6) {\n    var cx = mat[12]/w\n    var cy = mat[13]/w\n    var cz = mat[14]/w\n\n    this.recalcMatrix(t)  \n    var r = Math.exp(this.computedRadius[0])\n    this.center.set(t, cx-mat[2]*r, cy-mat[6]*r, cz-mat[10]*r)\n    this.radius.idle(t)\n  } else {\n    this.center.idle(t)\n    this.radius.idle(t)\n  }\n}\n\nproto.setDistance = function(t, d) {\n  if(d > 0) {\n    this.radius.set(t, Math.log(d))\n  }\n}\n\nproto.setDistanceLimits = function(lo, hi) {\n  if(lo > 0) {\n    lo = Math.log(lo)\n  } else {\n    lo = -Infinity    \n  }\n  if(hi > 0) {\n    hi = Math.log(hi)\n  } else {\n    hi = Infinity\n  }\n  hi = Math.max(hi, lo)\n  this.radius.bounds[0][0] = lo\n  this.radius.bounds[1][0] = hi\n}\n\nproto.getDistanceLimits = function(out) {\n  var bounds = this.radius.bounds\n  if(out) {\n    out[0] = Math.exp(bounds[0][0])\n    out[1] = Math.exp(bounds[1][0])\n    return out\n  }\n  return [ Math.exp(bounds[0][0]), Math.exp(bounds[1][0]) ]\n}\n\nproto.toJSON = function() {\n  this.recalcMatrix(this.lastT())\n  return {\n    center:   this.computedCenter.slice(),\n    rotation: this.computedRotation.slice(),\n    distance: Math.log(this.computedRadius[0]),\n    zoomMin:  this.radius.bounds[0][0],\n    zoomMax:  this.radius.bounds[1][0]\n  }\n}\n\nproto.fromJSON = function(options) {\n  var t = this.lastT()\n  var c = options.center\n  if(c) {\n    this.center.set(t, c[0], c[1], c[2])\n  }\n  var r = options.rotation\n  if(r) {\n    this.rotation.set(t, r[0], r[1], r[2], r[3])\n  }\n  var d = options.distance\n  if(d && d > 0) {\n    this.radius.set(t, Math.log(d))\n  }\n  this.setDistanceLimits(options.zoomMin, options.zoomMax)\n}\n\nfunction createOrbitController(options) {\n  options = options || {}\n  var center   = options.center   || [0,0,0]\n  var rotation = options.rotation || [0,0,0,1]\n  var radius   = options.radius   || 1.0\n\n  center = [].slice.call(center, 0, 3)\n  rotation = [].slice.call(rotation, 0, 4)\n  normalize4(rotation, rotation)\n\n  var result = new OrbitCameraController(\n    rotation,\n    center,\n    Math.log(radius))\n\n  result.setDistanceLimits(options.zoomMin, options.zoomMax)\n\n  if('eye' in options || 'up' in options) {\n    result.lookAt(0, options.eye, options.center, options.up)\n  }\n\n  return result\n}"]},"metadata":{},"sourceType":"script"}