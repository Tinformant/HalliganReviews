{"ast":null,"code":"/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n'use strict';\n\nvar Registry = require('../../registry');\n\nvar Lib = require('../../lib');\n\nvar Axes = require('../../plots/cartesian/axes');\n\nvar histogram2dCalc = require('../histogram2d/calc');\n\nvar colorscaleCalc = require('../../components/colorscale/calc');\n\nvar convertColumnData = require('./convert_column_xyz');\n\nvar clean2dArray = require('./clean_2d_array');\n\nvar interp2d = require('./interp2d');\n\nvar findEmpties = require('./find_empties');\n\nvar makeBoundArray = require('./make_bound_array');\n\nvar BADNUM = require('../../constants/numerical').BADNUM;\n\nmodule.exports = function calc(gd, trace) {\n  // prepare the raw data\n  // run makeCalcdata on x and y even for heatmaps, in case of category mappings\n  var xa = Axes.getFromId(gd, trace.xaxis || 'x');\n  var ya = Axes.getFromId(gd, trace.yaxis || 'y');\n  var isContour = Registry.traceIs(trace, 'contour');\n  var isHist = Registry.traceIs(trace, 'histogram');\n  var isGL2D = Registry.traceIs(trace, 'gl2d');\n  var zsmooth = isContour ? 'best' : trace.zsmooth;\n  var x;\n  var x0;\n  var dx;\n  var y;\n  var y0;\n  var dy;\n  var z;\n  var i;\n  var binned; // cancel minimum tick spacings (only applies to bars and boxes)\n\n  xa._minDtick = 0;\n  ya._minDtick = 0;\n\n  if (isHist) {\n    binned = histogram2dCalc(gd, trace);\n    x = binned.x;\n    x0 = binned.x0;\n    dx = binned.dx;\n    y = binned.y;\n    y0 = binned.y0;\n    dy = binned.dy;\n    z = binned.z;\n  } else {\n    var zIn = trace.z;\n\n    if (Lib.isArray1D(zIn)) {\n      convertColumnData(trace, xa, ya, 'x', 'y', ['z']);\n      x = trace._x;\n      y = trace._y;\n      zIn = trace._z;\n    } else {\n      x = trace._x = trace.x ? xa.makeCalcdata(trace, 'x') : [];\n      y = trace._y = trace.y ? ya.makeCalcdata(trace, 'y') : [];\n    }\n\n    x0 = trace.x0;\n    dx = trace.dx;\n    y0 = trace.y0;\n    dy = trace.dy;\n    z = clean2dArray(zIn, trace, xa, ya);\n  }\n\n  if (xa.rangebreaks || ya.rangebreaks) {\n    z = dropZonBreaks(x, y, z);\n\n    if (!isHist) {\n      x = skipBreaks(x);\n      y = skipBreaks(y);\n      trace._x = x;\n      trace._y = y;\n    }\n  }\n\n  if (!isHist && (isContour || trace.connectgaps)) {\n    trace._emptypoints = findEmpties(z);\n    interp2d(z, trace._emptypoints);\n  }\n\n  function noZsmooth(msg) {\n    zsmooth = trace._input.zsmooth = trace.zsmooth = false;\n    Lib.warn('cannot use zsmooth: \"fast\": ' + msg);\n  } // check whether we really can smooth (ie all boxes are about the same size)\n\n\n  if (zsmooth === 'fast') {\n    if (xa.type === 'log' || ya.type === 'log') {\n      noZsmooth('log axis found');\n    } else if (!isHist) {\n      if (x.length) {\n        var avgdx = (x[x.length - 1] - x[0]) / (x.length - 1);\n        var maxErrX = Math.abs(avgdx / 100);\n\n        for (i = 0; i < x.length - 1; i++) {\n          if (Math.abs(x[i + 1] - x[i] - avgdx) > maxErrX) {\n            noZsmooth('x scale is not linear');\n            break;\n          }\n        }\n      }\n\n      if (y.length && zsmooth === 'fast') {\n        var avgdy = (y[y.length - 1] - y[0]) / (y.length - 1);\n        var maxErrY = Math.abs(avgdy / 100);\n\n        for (i = 0; i < y.length - 1; i++) {\n          if (Math.abs(y[i + 1] - y[i] - avgdy) > maxErrY) {\n            noZsmooth('y scale is not linear');\n            break;\n          }\n        }\n      }\n    }\n  } // create arrays of brick boundaries, to be used by autorange and heatmap.plot\n\n\n  var xlen = Lib.maxRowLength(z);\n  var xIn = trace.xtype === 'scaled' ? '' : x;\n  var xArray = makeBoundArray(trace, xIn, x0, dx, xlen, xa);\n  var yIn = trace.ytype === 'scaled' ? '' : y;\n  var yArray = makeBoundArray(trace, yIn, y0, dy, z.length, ya); // handled in gl2d convert step\n\n  if (!isGL2D) {\n    trace._extremes[xa._id] = Axes.findExtremes(xa, xArray);\n    trace._extremes[ya._id] = Axes.findExtremes(ya, yArray);\n  }\n\n  var cd0 = {\n    x: xArray,\n    y: yArray,\n    z: z,\n    text: trace._text || trace.text,\n    hovertext: trace._hovertext || trace.hovertext\n  };\n  if (xIn && xIn.length === xArray.length - 1) cd0.xCenter = xIn;\n  if (yIn && yIn.length === yArray.length - 1) cd0.yCenter = yIn;\n\n  if (isHist) {\n    cd0.xRanges = binned.xRanges;\n    cd0.yRanges = binned.yRanges;\n    cd0.pts = binned.pts;\n  }\n\n  if (!isContour) {\n    colorscaleCalc(gd, trace, {\n      vals: z,\n      cLetter: 'z'\n    });\n  }\n\n  if (isContour && trace.contours && trace.contours.coloring === 'heatmap') {\n    var dummyTrace = {\n      type: trace.type === 'contour' ? 'heatmap' : 'histogram2d',\n      xcalendar: trace.xcalendar,\n      ycalendar: trace.ycalendar\n    };\n    cd0.xfill = makeBoundArray(dummyTrace, xIn, x0, dx, xlen, xa);\n    cd0.yfill = makeBoundArray(dummyTrace, yIn, y0, dy, z.length, ya);\n  }\n\n  return [cd0];\n};\n\nfunction skipBreaks(a) {\n  var b = [];\n  var len = a.length;\n\n  for (var i = 0; i < len; i++) {\n    var v = a[i];\n    if (v !== BADNUM) b.push(v);\n  }\n\n  return b;\n}\n\nfunction dropZonBreaks(x, y, z) {\n  var newZ = [];\n  var k = -1;\n\n  for (var i = 0; i < z.length; i++) {\n    if (y[i] === BADNUM) continue;\n    k++;\n    newZ[k] = [];\n\n    for (var j = 0; j < z[i].length; j++) {\n      if (x[j] === BADNUM) continue;\n      newZ[k].push(z[i][j]);\n    }\n  }\n\n  return newZ;\n}","map":{"version":3,"sources":["/Users/jingkaisu/Documents/HRfront/HalliganReviews/web_project/node_modules/plotly.js/src/traces/heatmap/calc.js"],"names":["Registry","require","Lib","Axes","histogram2dCalc","colorscaleCalc","convertColumnData","clean2dArray","interp2d","findEmpties","makeBoundArray","BADNUM","module","exports","calc","gd","trace","xa","getFromId","xaxis","ya","yaxis","isContour","traceIs","isHist","isGL2D","zsmooth","x","x0","dx","y","y0","dy","z","i","binned","_minDtick","zIn","isArray1D","_x","_y","_z","makeCalcdata","rangebreaks","dropZonBreaks","skipBreaks","connectgaps","_emptypoints","noZsmooth","msg","_input","warn","type","length","avgdx","maxErrX","Math","abs","avgdy","maxErrY","xlen","maxRowLength","xIn","xtype","xArray","yIn","ytype","yArray","_extremes","_id","findExtremes","cd0","text","_text","hovertext","_hovertext","xCenter","yCenter","xRanges","yRanges","pts","vals","cLetter","contours","coloring","dummyTrace","xcalendar","ycalendar","xfill","yfill","a","b","len","v","push","newZ","k","j"],"mappings":"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","sourcesContent":["/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n\n'use strict';\n\nvar Registry = require('../../registry');\nvar Lib = require('../../lib');\nvar Axes = require('../../plots/cartesian/axes');\n\nvar histogram2dCalc = require('../histogram2d/calc');\nvar colorscaleCalc = require('../../components/colorscale/calc');\nvar convertColumnData = require('./convert_column_xyz');\nvar clean2dArray = require('./clean_2d_array');\nvar interp2d = require('./interp2d');\nvar findEmpties = require('./find_empties');\nvar makeBoundArray = require('./make_bound_array');\nvar BADNUM = require('../../constants/numerical').BADNUM;\n\nmodule.exports = function calc(gd, trace) {\n    // prepare the raw data\n    // run makeCalcdata on x and y even for heatmaps, in case of category mappings\n    var xa = Axes.getFromId(gd, trace.xaxis || 'x');\n    var ya = Axes.getFromId(gd, trace.yaxis || 'y');\n    var isContour = Registry.traceIs(trace, 'contour');\n    var isHist = Registry.traceIs(trace, 'histogram');\n    var isGL2D = Registry.traceIs(trace, 'gl2d');\n    var zsmooth = isContour ? 'best' : trace.zsmooth;\n    var x;\n    var x0;\n    var dx;\n    var y;\n    var y0;\n    var dy;\n    var z;\n    var i;\n    var binned;\n\n    // cancel minimum tick spacings (only applies to bars and boxes)\n    xa._minDtick = 0;\n    ya._minDtick = 0;\n\n    if(isHist) {\n        binned = histogram2dCalc(gd, trace);\n        x = binned.x;\n        x0 = binned.x0;\n        dx = binned.dx;\n        y = binned.y;\n        y0 = binned.y0;\n        dy = binned.dy;\n        z = binned.z;\n    } else {\n        var zIn = trace.z;\n        if(Lib.isArray1D(zIn)) {\n            convertColumnData(trace, xa, ya, 'x', 'y', ['z']);\n            x = trace._x;\n            y = trace._y;\n            zIn = trace._z;\n        } else {\n            x = trace._x = trace.x ? xa.makeCalcdata(trace, 'x') : [];\n            y = trace._y = trace.y ? ya.makeCalcdata(trace, 'y') : [];\n        }\n\n        x0 = trace.x0;\n        dx = trace.dx;\n        y0 = trace.y0;\n        dy = trace.dy;\n\n        z = clean2dArray(zIn, trace, xa, ya);\n    }\n\n    if(xa.rangebreaks || ya.rangebreaks) {\n        z = dropZonBreaks(x, y, z);\n\n        if(!isHist) {\n            x = skipBreaks(x);\n            y = skipBreaks(y);\n\n            trace._x = x;\n            trace._y = y;\n        }\n    }\n\n    if(!isHist && (isContour || trace.connectgaps)) {\n        trace._emptypoints = findEmpties(z);\n        interp2d(z, trace._emptypoints);\n    }\n\n    function noZsmooth(msg) {\n        zsmooth = trace._input.zsmooth = trace.zsmooth = false;\n        Lib.warn('cannot use zsmooth: \"fast\": ' + msg);\n    }\n\n    // check whether we really can smooth (ie all boxes are about the same size)\n    if(zsmooth === 'fast') {\n        if(xa.type === 'log' || ya.type === 'log') {\n            noZsmooth('log axis found');\n        } else if(!isHist) {\n            if(x.length) {\n                var avgdx = (x[x.length - 1] - x[0]) / (x.length - 1);\n                var maxErrX = Math.abs(avgdx / 100);\n                for(i = 0; i < x.length - 1; i++) {\n                    if(Math.abs(x[i + 1] - x[i] - avgdx) > maxErrX) {\n                        noZsmooth('x scale is not linear');\n                        break;\n                    }\n                }\n            }\n            if(y.length && zsmooth === 'fast') {\n                var avgdy = (y[y.length - 1] - y[0]) / (y.length - 1);\n                var maxErrY = Math.abs(avgdy / 100);\n                for(i = 0; i < y.length - 1; i++) {\n                    if(Math.abs(y[i + 1] - y[i] - avgdy) > maxErrY) {\n                        noZsmooth('y scale is not linear');\n                        break;\n                    }\n                }\n            }\n        }\n    }\n\n    // create arrays of brick boundaries, to be used by autorange and heatmap.plot\n    var xlen = Lib.maxRowLength(z);\n    var xIn = trace.xtype === 'scaled' ? '' : x;\n    var xArray = makeBoundArray(trace, xIn, x0, dx, xlen, xa);\n    var yIn = trace.ytype === 'scaled' ? '' : y;\n    var yArray = makeBoundArray(trace, yIn, y0, dy, z.length, ya);\n\n    // handled in gl2d convert step\n    if(!isGL2D) {\n        trace._extremes[xa._id] = Axes.findExtremes(xa, xArray);\n        trace._extremes[ya._id] = Axes.findExtremes(ya, yArray);\n    }\n\n    var cd0 = {\n        x: xArray,\n        y: yArray,\n        z: z,\n        text: trace._text || trace.text,\n        hovertext: trace._hovertext || trace.hovertext\n    };\n\n    if(xIn && xIn.length === xArray.length - 1) cd0.xCenter = xIn;\n    if(yIn && yIn.length === yArray.length - 1) cd0.yCenter = yIn;\n\n    if(isHist) {\n        cd0.xRanges = binned.xRanges;\n        cd0.yRanges = binned.yRanges;\n        cd0.pts = binned.pts;\n    }\n\n    if(!isContour) {\n        colorscaleCalc(gd, trace, {vals: z, cLetter: 'z'});\n    }\n\n    if(isContour && trace.contours && trace.contours.coloring === 'heatmap') {\n        var dummyTrace = {\n            type: trace.type === 'contour' ? 'heatmap' : 'histogram2d',\n            xcalendar: trace.xcalendar,\n            ycalendar: trace.ycalendar\n        };\n        cd0.xfill = makeBoundArray(dummyTrace, xIn, x0, dx, xlen, xa);\n        cd0.yfill = makeBoundArray(dummyTrace, yIn, y0, dy, z.length, ya);\n    }\n\n    return [cd0];\n};\n\nfunction skipBreaks(a) {\n    var b = [];\n    var len = a.length;\n    for(var i = 0; i < len; i++) {\n        var v = a[i];\n        if(v !== BADNUM) b.push(v);\n    }\n    return b;\n}\n\nfunction dropZonBreaks(x, y, z) {\n    var newZ = [];\n    var k = -1;\n    for(var i = 0; i < z.length; i++) {\n        if(y[i] === BADNUM) continue;\n        k++;\n        newZ[k] = [];\n        for(var j = 0; j < z[i].length; j++) {\n            if(x[j] === BADNUM) continue;\n\n            newZ[k].push(z[i][j]);\n        }\n    }\n    return newZ;\n}\n"]},"metadata":{},"sourceType":"script"}